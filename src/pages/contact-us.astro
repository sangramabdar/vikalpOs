---
import Button from "../components/common/Button.astro";
import Input from "../components/common/Input.astro";
import SectionContainer from "../components/common/section/SectionContainer.astro";
import HeroSection from "../components/HeroSection.astro";
import Layout from "../layouts/Layout.astro";
import Wrapper from "../layouts/Wrapper.astro";
import { cn } from "../utils/cn";

const heroSectionData = {
  headers: ["Get in Touch", "With Our Team Experts"],
  description: `Have questions, need a demo, or wish to discuss how VikalpOS can transform your department? 
Our team is here to help you accelerate digital governance and deliver better outcomes`,
};

const formSectionData = {
  headers: ["What to Expect", "When You Reach Out"],
  options: [
    "Fill out the form and click “Request a Demo",
    "Our team will quickly review your request and reach out to you",
    "We’ll organize a demo tailored to your department’s needs",
  ],
};
---

<Layout>
  <HeroSection
    headers={heroSectionData.headers}
    description={heroSectionData.description}
  >
    <div class="h-fit slideInLeft">
      <img
        src="https://res.cloudinary.com/senpiper/image/upload/v1753764912/senpiper_assets/VikalpOS/Group_1000005383_x97fwz.svg"
        alt="#"
        class="w-fit"
      />
    </div>
  </HeroSection>

  <SectionContainer>
    <Wrapper>
      <div class={`grid grid-cols-1 lg:grid-cols-2 gap-10`}>
        <form id="contact-us-form" class="flex flex-col gap-6 slideInUp">
          <Input title="Name" id="title" name="name" type="text" required />
          <Input title="Email" id="title" name="email" type="email" required />
          <Input
            title="Organization Name"
            id="title"
            name="organizationName"
            required
          />
          <Input title="Message" name="message" id="message" />
          <div class="flex justify-center">
            <Button type="submit" text="Requst a demo" id="submitButton" />
          </div>
        </form>
        <div class="flex flex-col justify-center slideInDown gap-3 md:gap-4">
          <h3
            class="text-typography-80 font-bold text-left text-xl md:text-3xl slideInDownSub"
          >
            {
              formSectionData.headers.map((header, index) => (
                <span
                  class={index == 0 ? "text-typography-80" : "text-primary-70"}
                >
                  {header}
                </span>
              ))
            }
          </h3>
          <ul class="space-y-2 text-left self-start md:text-xl">
            {
              formSectionData.options.map((value, index) => (
                <li class={cn("flex gap-2 slideInDownSub transition-all")}>
                  <img src="https://res.cloudinary.com/senpiper/image/upload/v1753788029/senpiper_assets/VikalpOS/icons/check_circle_en544w.svg" />
                  <span class="text-typography-80 text-base">{value}</span>
                </li>
              ))
            }
          </ul>
        </div>
      </div>
    </Wrapper>
  </SectionContainer>
</Layout>

<script>
  const formData: any = {};

  const form = document.getElementById("contact-us-form");

  const submitBtn = document.getElementById(
    "submitButton"
  ) as HTMLButtonElement;

  const inputFields = document
    .getElementById("contact-us-form")
    ?.getElementsByTagName("input") as any;

  function getUUID() {
    const s4 = () =>
      Math.floor((1 + Math.random()) * 0x10000)
        .toString(16)
        .substring(1);

    return `${s4() + s4()}-${s4()}-${s4()}-${s4()}-${s4()}${s4()}${s4()}`;
  }

  function buidData(formData: any) {
    const jsonFormData = { ...formData };

    let groupId = "fd8ded3c-b2fd-479b-a2a1-8ce9398b45f4";
    let formId = "189f6180-dc67-4a0c-88b9-9c403293e2f7";

    const path = window.location?.href || "";
    if (path.includes("staging") || path.includes("localhost")) {
      groupId = "f5026482-ac45-492a-9914-7959de2073e9";
      formId = "f82e5ce7-4a54-4789-967f-d3f7724c6d82";
    }

    const answer = {
      answer: {
        f: jsonFormData["name"],
        e: jsonFormData["email"],
        o: jsonFormData["organizationName"],
        m: jsonFormData["message"],
      },
      groupId: groupId,
      formId: formId,
      hash: getUUID(),
      referer: "WEB",
    };
    return answer;
  }

  async function postForm(formData: any) {
    try {
      let url = "https://tech.senpiper.com/api/core/form/answer/public";
      const path = window.location?.href || "";
      if (path.includes("staging") || path.includes("localhost")) {
        url = "https://rb.staging.senpiper.com/api/core/form/answer/public";
      }
      await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(formData),
      });

      return true;
    } catch (err) {
      console.error(`Error on POST: ${err}`);
      return null;
    }
  }

  async function submitFormToBackend(e: Event) {
    e.preventDefault();
    const fields = document.getElementById("fields");
    const successMsg = document.getElementById("successMsg");
    submitBtn.disabled = true;
    submitBtn.innerHTML = "Sending request";
    submitBtn.classList.remove("hvr-sweep-to-right");

    const jsonFormData = buidData(formData);

    // const response = await postForm(jsonFormData);

    setTimeout(() => {
      if (response) {
        submitBtn.innerHTML = "Request Submitted";
        submitBtn.classList.remove("bg-light-violet");
        submitBtn.classList.add("bg-green");
        fields.classList.add("hidden");
        successMsg.classList.remove("hidden");
      } else {
        submitBtn.innerHTML = "Request failed, please try again";
        submitBtn.classList.remove("bg-light-violet");
        submitBtn.classList.add("bg-[#FD464E]");
        setTimeout(() => {
          submitBtn.disabled = false;
          submitBtn.innerHTML = "Get a demo";
          submitBtn.classList.add("bg-light-violet");
          submitBtn.classList.remove("bg-[#FD464E]");
          submitBtn.classList.add("hvr-sweep-to-right");
        }, 4000);
      }
    }, 2000);
  }

  const validateFormData = () => {};

  const handleOnSubmit = (event: Event) => {
    event.preventDefault();
    console.log(formData);

    submitFormToBackend(event);
  };

  form?.addEventListener("submit", handleOnSubmit);

  const handleOnChange = (key: string) => (event: any) => {
    const value = event.target?.value;
    formData[key] = value;
  };

  for (let i = 0; i < inputFields?.length; i++) {
    const key = inputFields[i]?.name;

    inputFields[i].addEventListener("input", handleOnChange(key));
  }
</script>
